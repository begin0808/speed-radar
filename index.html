<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸¬é€Ÿç…§ç›¸è­¦ç¤ºç³»çµ± (Firebase Live Data)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #1a1a1a; }
        #map { height: 100%; width: 100%; z-index: 1; }
        #alert-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 0, 0, 0.3); border: 8px solid red;
            display: none; z-index: 9999; pointer-events: none;
            animation: pulse 0.8s infinite;
        }
        #dashboard {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 420px;
            background: rgba(17, 24, 39, 0.9); color: white;
            padding: 15px; border-radius: 16px; z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(8px);
        }
        #top-bar {
            position: fixed; top: 15px; left: 15px; right: 15px;
            z-index: 1000; display: flex; justify-content: space-between; pointer-events: none;
        }
        .btn-control {
            pointer-events: auto; background: rgba(255, 255, 255, 0.9); color: #1f2937;
            padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: none; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-control:active { transform: scale(0.95); }
        @keyframes pulse {
            0% { opacity: 0.3; border-color: rgba(220, 38, 38, 0.4); }
            50% { opacity: 1; border-color: rgba(220, 38, 38, 1); }
            100% { opacity: 0.3; border-color: rgba(220, 38, 38, 0.4); }
        }
        .camera-icon-img { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); transition: transform 0.3s; }
    </style>
</head>
<body>

    <div id="alert-overlay"></div>

    <div id="top-bar">
        <button onclick="enableAudio()" id="btn-audio" class="btn-control">
            ğŸ”‡ é–‹å•ŸèªéŸ³
        </button>
        <div class="flex gap-2">
            <button onclick="startGPS()" class="btn-control bg-green-600 text-white! hover:bg-green-700">
                ğŸ›°ï¸ çœŸå¯¦ GPS
            </button>
            <button onclick="toggleSimulation()" class="btn-control bg-blue-600 text-white! hover:bg-blue-700">
                ğŸš— æ¨¡æ“¬
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div id="dashboard">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <span id="gps-indicator" class="w-2 h-2 rounded-full bg-gray-500"></span>
                <span id="gps-text" class="text-xs text-gray-400">GPS æœªå•Ÿå‹•</span>
            </div>
            <div id="db-status" class="text-[10px] bg-yellow-700 px-2 py-1 rounded text-gray-200">
                é€£ç·š Firebase ä¸­...
            </div>
        </div>

        <div class="flex justify-between items-end">
            <div>
                <div class="text-gray-400 text-xs font-bold tracking-wider">SPEED</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-5xl font-black font-mono tracking-tighter" id="speed-display">0</span>
                    <span class="text-sm text-gray-500 font-bold">km/h</span>
                </div>
            </div>
            <div class="text-right flex flex-col items-end">
                <div class="text-gray-400 text-xs font-bold tracking-wider mb-1">DISTANCE</div>
                <div class="text-3xl font-bold text-gray-500 font-mono" id="distance-display">-- <span class="text-sm">m</span></div>
                <div id="limit-box" class="mt-2 flex items-center gap-2 opacity-30 transition-opacity duration-300">
                    <span class="text-xs text-gray-400">é€Ÿé™</span>
                    <div class="w-8 h-8 rounded-full border-2 border-red-500 flex items-center justify-center bg-white text-black font-bold text-sm" id="limit-val">--</div>
                </div>
            </div>
        </div>

        <div id="alert-message-box" class="mt-3 py-2 px-3 bg-gray-800 rounded-lg text-center hidden transition-all duration-300">
            <span id="alert-text" class="text-lg font-bold"></span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Firebase SDK (Version 11.6.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // âš ï¸âš ï¸âš ï¸ã€é—œéµä¿®æ”¹ï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase Configã€‘âš ï¸âš ï¸âš ï¸
        // å¦‚æœæ‚¨æ˜¯åœ¨ã€Œæœ¬åœ°é›»è…¦ã€æ‰“é–‹æ­¤æª”æ¡ˆï¼Œè«‹å‹™å¿…å°‡ä¸‹æ–¹çš„ firebaseConfig æ›¿æ›æˆæ‚¨è‡ªå·±çš„è¨­å®šï¼
        // 1. å» Firebase Console -> Project Settings -> General -> Your apps -> SDK setup and configuration -> Config
        // 2. è¤‡è£½é‚£ä¸€æ®µ const firebaseConfig = { ... }; è²¼ä¸Šè¦†è“‹ä¸‹æ–¹å…§å®¹
        
        const firebaseConfig = {
  apiKey: "AIzaSyD7C4nl7aMFCNBOzCZH5Jup-sXxXRMOxfY",
  authDomain: "speedcameraapp-36faa.firebaseapp.com",
  projectId: "speedcameraapp-36faa",
  storageBucket: "speedcameraapp-36faa.firebasestorage.app",
  messagingSenderId: "610700934168",
  appId: "1:610700934168:web:ec96ec3de0749fb7fed76d",
  measurementId: "G-WBMFXYPJFN"
};
        // -------------------------------------------------------------

        // åµæ¸¬æ˜¯å¦åœ¨ Canvas é è¦½ç’°å¢ƒ (æ‚¨åœ¨æœ¬åœ°åŸ·è¡Œæ™‚ï¼Œé€™æ®µæœƒè‡ªå‹•è·³é)
        let finalConfig = firebaseConfig;
        let isPreviewEnv = false;
        let currentAppId = 'default';
        
        try {
            if (typeof __firebase_config !== 'undefined') {
                finalConfig = JSON.parse(__firebase_config);
                currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                isPreviewEnv = true;
            }
        } catch (e) {
            console.log("æœ¬åœ°æ¨¡å¼ï¼šä½¿ç”¨æ‰‹å‹•å¡«å¯«çš„ Config");
        }

        // åˆå§‹åŒ– Firebase
        let app, db, auth;
        try {
            app = initializeApp(finalConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            document.getElementById('db-status').innerText = "è¨­å®šéŒ¯èª¤ï¼šè«‹æª¢æŸ¥ HTML å…§çš„ firebaseConfig";
            document.getElementById('db-status').classList.replace('bg-yellow-700', 'bg-red-700');
            alert("âš ï¸ éŒ¯èª¤ï¼šè«‹ç”¨è¨˜äº‹æœ¬æ‰“é–‹ HTML æª”æ¡ˆï¼Œå¡«å…¥æ‚¨çš„ Firebase Configï¼\n(è«‹åƒè€ƒç¨‹å¼ç¢¼å…§çš„è¨»è§£)");
            throw e;
        }

        // ç™»å…¥ç¨‹åº
        const initAuth = async () => {
            const statusTag = document.getElementById('db-status');
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                statusTag.innerText = "é©—è­‰æˆåŠŸï¼Œæ­£åœ¨è¼‰å…¥...";
                statusTag.classList.replace('bg-yellow-700', 'bg-blue-700');
            } catch (error) {
                console.error("Auth Failed", error);
                
                // æ›´è©³ç´°çš„éŒ¯èª¤æç¤º
                let errorMsg = `é©—è­‰å¤±æ•—: ${error.code || error.message}`;
                statusTag.innerText = errorMsg;
                statusTag.classList.replace('bg-yellow-700', 'bg-red-700');

                if (error.code === 'auth/operation-not-allowed') {
                    alert("âš ï¸ éŒ¯èª¤ï¼šæ‚¨å°šæœªåœ¨ Firebase å¾Œå°å•Ÿç”¨ã€ŒåŒ¿åç™»å…¥ã€ã€‚\nè«‹å» Authentication -> Sign-in method é–‹å•Ÿ Anonymousã€‚");
                } else if (error.code === 'auth/invalid-api-key') {
                    alert("âš ï¸ éŒ¯èª¤ï¼šç„¡æ•ˆçš„ API Keyã€‚\nè«‹æª¢æŸ¥ HTML æª”æ¡ˆä¸­çš„ firebaseConfig æ˜¯å¦å·²å¡«å…¥æ­£ç¢ºè³‡è¨Šã€‚");
                }
            }
        };

        initAuth();

        // ç›£è½ Auth ç‹€æ…‹æ”¹è®Š
        onAuthStateChanged(auth, async (user) => {
            if (!user) return;
            
            const statusTag = document.getElementById('db-status');
            
            // âš ï¸ è³‡æ–™åº«è·¯å¾‘é¸æ“‡ï¼š
            // - æœ¬åœ°åŸ·è¡Œï¼šè®€å–æ ¹ç›®éŒ„çš„ "speed_cameras" (å°æ‡‰æ‚¨çš„ update_data.js)
            // - é è¦½ç’°å¢ƒï¼šè®€å– "artifacts/.../speed_cameras"
            let q;
            if (isPreviewEnv) {
                 const collectionPath = `artifacts/${currentAppId}/public/data/speed_cameras`;
                 q = query(collection(db, collectionPath));
                 // åƒ…åœ¨é è¦½ç’°å¢ƒæª¢æŸ¥ç¨®å­è³‡æ–™
                 await checkAndSeedData(collectionPath);
            } else {
                 // æœ¬åœ°æ¨¡å¼ï¼šç›´æ¥è®€å–æ‚¨å¾Œç«¯è…³æœ¬å¯«å…¥çš„é›†åˆ
                 q = query(collection(db, "speed_cameras"));
            }
            
            onSnapshot(q, (snapshot) => {
                const loadedCameras = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    let lat, lng;
                    // ç›¸å®¹ä¸åŒçš„ç¶“ç·¯åº¦æ¬„ä½åç¨±
                    if (data.location && data.location.latitude) {
                        lat = data.location.latitude;
                        lng = data.location.longitude;
                    } else if (data.lat && data.lng) {
                        lat = data.lat;
                        lng = data.lng;
                    }

                    if (lat && lng) {
                        loadedCameras.push({
                            id: doc.id,
                            lat: lat,
                            lng: lng,
                            limit: data.limit,
                            address: data.address
                        });
                    }
                });

                if (loadedCameras.length === 0) {
                     statusTag.innerText = "è³‡æ–™åº«ç‚ºç©º (è«‹åŸ·è¡Œ node update_data.js)";
                     statusTag.classList.replace('bg-blue-700', 'bg-red-700');
                } else {
                    window.updateCameras(loadedCameras);
                    statusTag.innerText = `ğŸ”¥ å·²é€£ç·š: ${loadedCameras.length} ç­†è³‡æ–™ (å³æ™‚)`;
                    statusTag.classList.replace('bg-blue-700', 'bg-green-700');
                }
            }, (error) => {
                console.error("Snapshot Error:", error);
                statusTag.innerText = "è³‡æ–™è®€å–å¤±æ•— (æ¬Šé™æˆ–é€£ç·š)";
                statusTag.classList.replace('bg-blue-700', 'bg-red-700');
                if (error.code === 'permission-denied') {
                    alert("è®€å–å¤±æ•—ï¼šæ¬Šé™ä¸è¶³ã€‚\nè«‹åˆ° Firebase Console -> Firestore Database -> Rules\nå°‡ allow read, write: if false; æ”¹ç‚º if true;");
                }
            });
        });

        // æª¢æŸ¥ä¸¦å¯«å…¥ç¯„ä¾‹è³‡æ–™çš„åŠŸèƒ½ (åƒ…é è¦½ç’°å¢ƒä½¿ç”¨)
        async function checkAndSeedData(path) {
            try {
                const colRef = collection(db, path);
                const snapshot = await getDocs(colRef);
                if (snapshot.empty) {
                    console.log("è³‡æ–™åº«ç‚ºç©ºï¼Œå¯«å…¥ç¯„ä¾‹è³‡æ–™...");
                    const mockData = [
                        { address: "ä¿¡ç¾©è·¯äº”æ®µ (æ¨¡æ“¬é»A)", limit: 50, lat: 25.032969, lng: 121.560000 },
                        { address: "æ¾é«˜è·¯ (æ¨¡æ“¬é»B)", limit: 60, lat: 25.035000, lng: 121.568000 }
                    ];
                    const promises = mockData.map(data => addDoc(colRef, data));
                    await Promise.all(promises);
                }
            } catch (e) {
                console.error("Seeding Error:", e);
            }
        }
    </script>

    <script>
        // --- ä¸»é‚è¼¯ (èˆ‡ Firebase åˆ†é›¢ï¼Œä¿æŒä¹¾æ·¨) ---
        const CONFIG = { WARN_DIST: 600, ALERT_DIST: 300, RESET_DIST: 800 };
        let map, userMarker;
        let cameras = [];
        let currentPos = { lat: 25.033964, lng: 121.564468 }; 
        let watchId = null;
        let audioEnabled = false;
        let speechState = { hasWarned600: false, hasWarned300: false, currentCameraId: null };
        let isSimulating = false;
        let simInterval;

        // 1. åˆå§‹åŒ–
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([currentPos.lat, currentPos.lng], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap', maxZoom: 19
            }).addTo(map);

            const carIcon = L.divIcon({
                className: 'custom-car',
                html: `<div style="background:#3B82F6; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 0 15px #3B82F6;"></div>`,
                iconSize: [24, 24], iconAnchor: [12, 12]
            });
            userMarker = L.marker([currentPos.lat, currentPos.lng], {icon: carIcon, zIndexOffset: 1000}).addTo(map);

            map.on('click', (e) => {
                if(!watchId) startSimulation(e.latlng); // åªæœ‰åœ¨éçœŸå¯¦ GPS æ¨¡å¼ä¸‹æ‰å…è¨±é»æ“Šæ¨¡æ“¬
            });
        }

        // 2. æ¥æ”¶ Firebase è³‡æ–™ä¸¦ç¹ªè£½
        window.updateCameras = function(dataList) {
            cameras = dataList;
            
            // æ¸…é™¤èˆŠæ¨™è¨˜ (å¦‚æœæœ‰çš„è©±)
            // é€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œç°¡å–®é‡ç¹ªï¼Œå¯¦å‹™ä¸Šæ‡‰ä½¿ç”¨ id è¿½è¹¤
            // ç§»é™¤èˆŠçš„ Marker
            map.eachLayer((layer) => {
                if(layer instanceof L.Marker && layer !== userMarker) {
                    map.removeLayer(layer);
                }
            });

            const icon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/3256/3256054.png',
                iconSize: [28, 28], iconAnchor: [14, 14], popupAnchor: [0, -10],
                className: 'camera-icon-img'
            });

            cameras.forEach(cam => {
                L.marker([cam.lat, cam.lng], {icon: icon})
                    .bindPopup(`<div class="text-black font-bold">${cam.address}<br>é™é€Ÿ: ${cam.limit}</div>`)
                    .addTo(map);
            });
            
            console.log("åœ°åœ–å·²æ›´æ–°çœŸå¯¦è³‡æ–™é»ä½");
        }

        // 3. æ ¸å¿ƒåµæ¸¬ (å…±ç”¨)
        function checkProximity(lat, lng, speed = 0) {
            if (cameras.length === 0) return;

            let minDist = Infinity;
            let nearestCam = null;

            // ç°¡å–®éæ­·
            for (let cam of cameras) {
                const d = getDistance(lat, lng, cam.lat, cam.lng);
                if (d < minDist) {
                    minDist = d;
                    nearestCam = cam;
                }
            }

            updateUI(minDist, nearestCam, speed);
            handleVoiceAlert(minDist, nearestCam);
        }

        // 4. çœŸå¯¦ GPS è¿½è¹¤
        function startGPS() {
            if (isSimulating) {
                clearInterval(simInterval);
                isSimulating = false;
            }

            if (!navigator.geolocation) {
                alert("ç€è¦½å™¨ä¸æ”¯æ´ GPS");
                return;
            }

            const indicator = document.getElementById('gps-indicator');
            const text = document.getElementById('gps-text');
            
            indicator.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
            text.innerText = "GPS å®šä½ä¸­...";

            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, speed } = pos.coords;
                    currentPos = { lat: latitude, lng: longitude };
                    
                    // æ›´æ–°åœ°åœ–
                    userMarker.setLatLng([latitude, longitude]);
                    map.setView([latitude, longitude], 17);
                    
                    // é€Ÿåº¦è™•ç† (m/s -> km/h)
                    const kmh = speed ? Math.round(speed * 3.6) : 0;
                    
                    checkProximity(latitude, longitude, kmh);

                    indicator.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                    text.innerText = "GPS é€£ç·šä¸­";
                },
                (err) => {
                    console.error(err);
                    indicator.className = "w-2 h-2 rounded-full bg-red-500";
                    text.innerText = "GPS è¨Šè™Ÿéºå¤±";
                },
                { enableHighAccuracy: true, maximumAge: 1000 }
            );
        }

        // 5. æ¨¡æ“¬è¡Œé§›
        function startSimulation(targetLatLng) {
            isSimulating = true;
            const start = currentPos;
            const steps = 200;
            let step = 0;
            
            // éš¨æ©Ÿç”¢ç”Ÿä¸€å€‹æ¨¡æ“¬é€Ÿåº¦
            let mockSpeed = Math.floor(Math.random() * 40) + 40; 

            simInterval = setInterval(() => {
                step++;
                const progress = step / steps;
                const lat = start.lat + (targetLatLng.lat - start.lat) * progress;
                const lng = start.lng + (targetLatLng.lng - start.lng) * progress;
                
                currentPos = { lat, lng };
                userMarker.setLatLng([lat, lng]);
                map.panTo([lat, lng]);

                checkProximity(lat, lng, mockSpeed);

                if (step >= steps) {
                    clearInterval(simInterval);
                    isSimulating = false;
                    updateUI(Infinity, null, 0);
                }
            }, 20);
        }

        function toggleSimulation() {
            alert("è«‹é»æ“Šåœ°åœ–ä»»æ„è™•é–‹å§‹æ¨¡æ“¬è¡Œé§›");
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateUI(dist, cam, speed) {
            document.getElementById('speed-display').innerText = speed;
            const elDist = document.getElementById('distance-display');
            const elOverlay = document.getElementById('alert-overlay');
            const elMsgBox = document.getElementById('alert-message-box');
            const elLimitBox = document.getElementById('limit-box');

            if (dist > 2000 || !cam) {
                elDist.innerText = "--";
                elOverlay.style.display = 'none';
                elMsgBox.classList.add('hidden');
                elLimitBox.classList.add('opacity-30');
                return;
            }

            elDist.innerText = Math.round(dist);
            document.getElementById('limit-val').innerText = cam.limit;
            elLimitBox.classList.remove('opacity-30');

            if (dist <= CONFIG.ALERT_DIST) {
                elOverlay.style.display = 'block';
                elMsgBox.classList.remove('hidden');
                elMsgBox.innerHTML = `<span class="text-xl font-bold text-red-400">âš ï¸ é™é€Ÿ ${cam.limit}</span>`;
                elDist.className = "text-3xl font-bold text-red-500 font-mono";
            } else if (dist <= CONFIG.WARN_DIST) {
                elOverlay.style.display = 'none';
                elMsgBox.classList.remove('hidden');
                elMsgBox.innerHTML = `<span class="text-lg font-bold text-yellow-300">ğŸ”” å‰æ–¹æ¸¬é€Ÿ</span>`;
                elDist.className = "text-3xl font-bold text-yellow-400 font-mono";
            } else {
                elOverlay.style.display = 'none';
                elMsgBox.classList.add('hidden');
                elDist.className = "text-3xl font-bold text-white font-mono";
            }
        }

        function handleVoiceAlert(dist, cam) {
            if (!audioEnabled || !cam) return;
            
            if (speechState.currentCameraId !== cam.id || dist > CONFIG.RESET_DIST) {
                speechState = { hasWarned600: false, hasWarned300: false, currentCameraId: cam.id };
            }

            if (dist <= CONFIG.WARN_DIST && dist > CONFIG.ALERT_DIST && !speechState.hasWarned600) {
                speak(`å‰æ–¹å…­ç™¾å…¬å°ºï¼Œæ¸¬é€Ÿç…§ç›¸ï¼Œé™é€Ÿ${cam.limit}`);
                speechState.hasWarned600 = true;
            }
            if (dist <= CONFIG.ALERT_DIST && !speechState.hasWarned300) {
                speak(`æ³¨æ„ï¼Œé™é€Ÿ${cam.limit}`);
                speechState.hasWarned300 = true;
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW'; u.rate = 1.2;
            window.speechSynthesis.speak(u);
        }

        function enableAudio() {
            audioEnabled = true;
            document.getElementById('btn-audio').innerText = "ğŸ”Š èªéŸ³é–‹å•Ÿ";
            speak("èªéŸ³å·²å•Ÿå‹•");
        }

        initMap();
    </script>
</body>
</html>