<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸¬é€Ÿç…§ç›¸è­¦ç¤ºç³»çµ± (Static Version)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #1a1a1a; }
        #map { height: 100%; width: 100%; z-index: 1; }
        #alert-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 0, 0, 0.3); border: 8px solid red;
            display: none; z-index: 9999; pointer-events: none;
            animation: pulse 0.8s infinite;
        }
        #dashboard {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 420px;
            background: rgba(17, 24, 39, 0.9); color: white;
            padding: 15px; border-radius: 16px; z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(8px);
        }
        #top-bar {
            position: fixed; top: 15px; left: 15px; right: 15px;
            z-index: 1000; display: flex; justify-content: space-between; pointer-events: none;
        }
        .btn-control {
            pointer-events: auto; background: rgba(255, 255, 255, 0.9); color: #1f2937;
            padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: none; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-control:active { transform: scale(0.95); }
        @keyframes pulse {
            0% { opacity: 0.3; border-color: rgba(220, 38, 38, 0.4); }
            50% { opacity: 1; border-color: rgba(220, 38, 38, 1); }
            100% { opacity: 0.3; border-color: rgba(220, 38, 38, 0.4); }
        }
        .camera-icon-img { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); transition: transform 0.3s; }
        .leaflet-control-layers { border: none !important; border-radius: 12px !important; box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important; padding: 8px !important; }
        .leaflet-control-layers-toggle { width: 44px !important; height: 44px !important; }
    </style>
</head>
<body>

    <div id="alert-overlay"></div>

    <div id="top-bar">
        <button onclick="enableAudio()" id="btn-audio" class="btn-control">
            ğŸ”‡ é–‹å•ŸèªéŸ³
        </button>
        <div class="flex gap-2">
            <button onclick="startGPS()" class="btn-control bg-green-600 text-white! hover:bg-green-700">
                ğŸ›°ï¸ çœŸå¯¦ GPS
            </button>
            <button onclick="toggleSimulation()" class="btn-control bg-blue-600 text-white! hover:bg-blue-700">
                ğŸš— æ¨¡æ“¬
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div id="dashboard">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <span id="gps-indicator" class="w-2 h-2 rounded-full bg-gray-500"></span>
                <span id="gps-text" class="text-xs text-gray-400">GPS æœªå•Ÿå‹•</span>
            </div>
            <div id="db-status" class="text-[10px] bg-yellow-700 px-2 py-1 rounded text-gray-200">
                è¼‰å…¥è³‡æ–™ä¸­...
            </div>
        </div>

        <div class="flex justify-between items-end">
            <div>
                <div class="text-gray-400 text-xs font-bold tracking-wider">SPEED</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-5xl font-black font-mono tracking-tighter" id="speed-display">0</span>
                    <span class="text-sm text-gray-500 font-bold">km/h</span>
                </div>
            </div>
            <div class="text-right flex flex-col items-end">
                <div class="text-gray-400 text-xs font-bold tracking-wider mb-1">DISTANCE</div>
                <div class="text-3xl font-bold text-gray-500 font-mono" id="distance-display">-- <span class="text-sm">m</span></div>
                <div id="limit-box" class="mt-2 flex items-center gap-2 opacity-30 transition-opacity duration-300">
                    <span class="text-xs text-gray-400">é€Ÿé™</span>
                    <div class="w-8 h-8 rounded-full border-2 border-red-500 flex items-center justify-center bg-white text-black font-bold text-sm" id="limit-val">--</div>
                </div>
            </div>
        </div>

        <div id="alert-message-box" class="mt-3 py-2 px-3 bg-gray-800 rounded-lg text-center hidden transition-all duration-300">
            <span id="alert-text" class="text-lg font-bold"></span>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- éœæ…‹æª”æ¡ˆè¨­å®š ---
        const DATA_URL = './cameras.json'; 

        // --- å…§å»ºæ¨¡æ“¬è³‡æ–™ (Fallback) ---
        // ç•¶ç„¡æ³•è®€å– JSON æª”æ™‚ (ä¾‹å¦‚åœ¨é è¦½ç’°å¢ƒæˆ–å°šæœªåŸ·è¡Œå¾Œç«¯è…³æœ¬)ï¼Œä½¿ç”¨æ­¤è³‡æ–™
        const MOCK_DATA = [
            { id: "mock1", address: "ä¿¡ç¾©è·¯äº”æ®µ (æ¨¡æ“¬é»)", limit: 50, lat: 25.032969, lng: 121.560000 },
            { id: "mock2", address: "æ¾é«˜è·¯ (æ¨¡æ“¬é»)", limit: 60, lat: 25.035000, lng: 121.568000 },
            { id: "mock3", address: "å…‰å¾©å—è·¯ (æ¨¡æ“¬é»)", limit: 40, lat: 25.040000, lng: 121.558000 },
            { id: "mock4", address: "èŠæ•¬è·¯ (æ¨¡æ“¬é»)", limit: 50, lat: 25.028000, lng: 121.565000 },
            { id: "mock5", address: "åŸºéš†è·¯ä¸€æ®µ (æ¨¡æ“¬é»)", limit: 50, lat: 25.041000, lng: 121.565000 }
        ];

        // --- ä¸»é‚è¼¯ ---
        const CONFIG = { WARN_DIST: 600, ALERT_DIST: 300, RESET_DIST: 800 };
        let map, userMarker;
        let cameras = [];
        let currentPos = { lat: 25.033964, lng: 121.564468 }; 
        let watchId = null;
        let audioEnabled = false;
        let speechState = { hasWarned600: false, hasWarned300: false, currentCameraId: null };
        let isSimulating = false;
        let simInterval;

        // 1. åˆå§‹åŒ–
        function init() {
            initMap();
            loadCameras();
        }

        function initMap() {
            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap, Â© CartoDB', maxZoom: 19
            });
            const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: 'Â© OpenStreetMap, Â© CartoDB', maxZoom: 19
            });
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap', maxZoom: 19
            });

            map = L.map('map', { zoomControl: false, layers: [darkLayer] }).setView([currentPos.lat, currentPos.lng], 15);
            L.control.layers({ "æ·±è‰²": darkLayer, "æ·ºè‰²": lightLayer, "è¡—é“": osmLayer }, null, {position: 'topright'}).addTo(map);

            const carIcon = L.divIcon({
                className: 'custom-car',
                html: `<div style="background:#3B82F6; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 0 15px #3B82F6;"></div>`,
                iconSize: [24, 24], iconAnchor: [12, 12]
            });
            userMarker = L.marker([currentPos.lat, currentPos.lng], {icon: carIcon, zIndexOffset: 1000}).addTo(map);

            map.on('click', (e) => {
                if(!watchId) startSimulation(e.latlng);
            });
        }

        // 2. è®€å– JSON è³‡æ–™ (åŠ å…¥éŒ¯èª¤è™•ç†)
        async function loadCameras() {
            const statusTag = document.getElementById('db-status');
            try {
                // å˜—è©¦è®€å–
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error("JSON not found or fetch failed");
                cameras = await response.json();
                
                statusTag.innerText = `âœ… å·²è¼‰å…¥: ${cameras.length} ç­†è³‡æ–™ (Static)`;
                statusTag.classList.replace('bg-yellow-700', 'bg-green-700');
            } catch (e) {
                console.warn("Fetch failed, using mock data. Reason:", e);
                
                // Fallback: ä½¿ç”¨å…§å»ºæ¨¡æ“¬è³‡æ–™
                cameras = MOCK_DATA;
                statusTag.innerText = "âš ï¸ é è¦½æ¨¡å¼: ä½¿ç”¨æ¨¡æ“¬è³‡æ–™ (JSON æœªè¼‰å…¥)";
                statusTag.classList.replace('bg-yellow-700', 'bg-blue-600');
            }

            // ç„¡è«–æ˜¯è®€å–æˆåŠŸé‚„æ˜¯ä½¿ç”¨ Mock Dataï¼Œéƒ½è¦ç¹ªè£½åœ°åœ–
            renderCameras();
        }

        function renderCameras() {
             const icon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/3256/3256054.png',
                iconSize: [28, 28], iconAnchor: [14, 14], popupAnchor: [0, -10],
                className: 'camera-icon-img'
            });

            cameras.forEach(cam => {
                L.marker([cam.lat, cam.lng], {icon: icon})
                    .bindPopup(`<div class="text-black font-bold">${cam.address}<br>é™é€Ÿ: ${cam.limit}</div>`)
                    .addTo(map);
            });
        }

        // 3. æ ¸å¿ƒåµæ¸¬ (ä¸è®Š)
        function checkProximity(lat, lng, speed = 0) {
            if (cameras.length === 0) return;
            let minDist = Infinity;
            let nearestCam = null;
            for (let cam of cameras) {
                const d = getDistance(lat, lng, cam.lat, cam.lng);
                if (d < minDist) {
                    minDist = d;
                    nearestCam = cam;
                }
            }
            updateUI(minDist, nearestCam, speed);
            handleVoiceAlert(minDist, nearestCam);
        }

        function startGPS() {
            if (isSimulating) { clearInterval(simInterval); isSimulating = false; }
            if (!navigator.geolocation) { alert("ä¸æ”¯æ´ GPS"); return; }
            document.getElementById('gps-indicator').className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, speed } = pos.coords;
                    currentPos = { lat: latitude, lng: longitude };
                    userMarker.setLatLng([latitude, longitude]);
                    map.setView([latitude, longitude], 17);
                    checkProximity(latitude, longitude, speed ? Math.round(speed * 3.6) : 0);
                    document.getElementById('gps-indicator').className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                    document.getElementById('gps-text').innerText = "GPS é€£ç·šä¸­";
                },
                (err) => { console.error(err); }, { enableHighAccuracy: true }
            );
        }

        function startSimulation(targetLatLng) {
            isSimulating = true;
            const start = currentPos;
            const steps = 200;
            let step = 0;
            let mockSpeed = Math.floor(Math.random() * 40) + 40; 
            simInterval = setInterval(() => {
                step++;
                const progress = step / steps;
                const lat = start.lat + (targetLatLng.lat - start.lat) * progress;
                const lng = start.lng + (targetLatLng.lng - start.lng) * progress;
                currentPos = { lat, lng };
                userMarker.setLatLng([lat, lng]);
                map.panTo([lat, lng]);
                checkProximity(lat, lng, mockSpeed);
                if (step >= steps) { clearInterval(simInterval); isSimulating = false; updateUI(Infinity, null, 0); }
            }, 20);
        }

        function toggleSimulation() { alert("é»æ“Šåœ°åœ–æ¨¡æ“¬è¡Œé§›"); }
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
            const a = Math.sin((lat2-lat1)*Math.PI/360)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin((lon2-lon1)*Math.PI/360)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function updateUI(dist, cam, speed) {
            document.getElementById('speed-display').innerText = speed;
            const elDist = document.getElementById('distance-display');
            const elMsgBox = document.getElementById('alert-message-box');
            if (dist > 2000 || !cam) {
                elDist.innerText = "--"; document.getElementById('alert-overlay').style.display = 'none'; elMsgBox.classList.add('hidden'); return;
            }
            elDist.innerText = Math.round(dist);
            document.getElementById('limit-val').innerText = cam.limit;
            if (dist <= CONFIG.ALERT_DIST) {
                document.getElementById('alert-overlay').style.display = 'block';
                elMsgBox.classList.remove('hidden');
                elMsgBox.innerHTML = `<span class="text-xl font-bold text-red-400">âš ï¸ é™é€Ÿ ${cam.limit}</span>`;
            } else if (dist <= CONFIG.WARN_DIST) {
                document.getElementById('alert-overlay').style.display = 'none';
                elMsgBox.classList.remove('hidden');
                elMsgBox.innerHTML = `<span class="text-lg font-bold text-yellow-300">ğŸ”” å‰æ–¹æ¸¬é€Ÿ</span>`;
            } else {
                document.getElementById('alert-overlay').style.display = 'none'; elMsgBox.classList.add('hidden');
            }
        }
        function handleVoiceAlert(dist, cam) {
            if (!audioEnabled || !cam) return;
            if (speechState.currentCameraId !== cam.id || dist > CONFIG.RESET_DIST) speechState = { hasWarned600: false, hasWarned300: false, currentCameraId: cam.id };
            if (dist <= CONFIG.WARN_DIST && dist > CONFIG.ALERT_DIST && !speechState.hasWarned600) { speak(`å‰æ–¹æ¸¬é€Ÿï¼Œé™é€Ÿ${cam.limit}`); speechState.hasWarned600 = true; }
            if (dist <= CONFIG.ALERT_DIST && !speechState.hasWarned300) { speak(`æ³¨æ„ï¼Œé™é€Ÿ${cam.limit}`); speechState.hasWarned300 = true; }
        }
        function speak(text) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'zh-TW'; u.rate = 1.2; window.speechSynthesis.speak(u); }
        function enableAudio() { audioEnabled = true; document.getElementById('btn-audio').innerText = "ğŸ”Š èªéŸ³é–‹å•Ÿ"; speak("èªéŸ³å•Ÿå‹•"); }
        
        init();
    </script>
</body>
</html>