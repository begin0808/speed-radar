<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸¬é€Ÿç…§ç›¸è­¦ç¤ºç³»çµ± (Road Match Ver.)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #1a1a1a; }
        #map { height: 100%; width: 100%; z-index: 1; }
        #alert-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 0, 0, 0.3); border: 8px solid red;
            display: none; z-index: 9999; pointer-events: none;
            animation: pulse 0.8s infinite;
        }
        #dashboard {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 420px;
            background: rgba(17, 24, 39, 0.95); color: white;
            padding: 15px; border-radius: 16px; z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(8px);
        }
        
        #top-left-controls {
            position: fixed; top: 15px; left: 15px;
            z-index: 1000; pointer-events: none;
        }

        #right-controls {
            position: fixed; 
            top: 80px;
            right: 10px;
            z-index: 1000; 
            display: flex; 
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            align-items: flex-end;
        }

        .btn-control {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.9); color: #1f2937;
            padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); border: none; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-control:active { transform: scale(0.95); }
        
        @keyframes pulse {
            0% { opacity: 0.3; border-color: rgba(220, 38, 38, 0.4); }
            50% { opacity: 1; border-color: rgba(220, 38, 38, 1); }
            100% { opacity: 0.3; border-color: rgba(220, 38, 38, 0.4); }
        }

        .camera-icon-img { transition: filter 0.3s; }
        .camera-icon-img { filter: invert(100%); } /* æ·±è‰²æ¨¡å¼é è¨­ç™½ */
        
        .mode-street .camera-icon-img,
        .mode-light .camera-icon-img {
            /* è½‰ç´…è‰² */
            filter: invert(16%) sepia(99%) saturate(7404%) hue-rotate(4deg) brightness(95%) contrast(118%);
        }

        .leaflet-control-layers { border: none !important; border-radius: 12px !important; box-shadow: 0 2px 10px rgba(0,0,0,0.3) !important; padding: 8px !important; }
        .leaflet-control-layers-toggle { width: 44px !important; height: 44px !important; }
        
        /* è·¯åé¡¯ç¤ºæ¨™ç±¤ */
        .road-badge {
            background: #3b82f6; color: white; 
            padding: 2px 8px; border-radius: 4px; 
            font-size: 0.75rem; margin-left: 8px;
            vertical-align: middle;
        }
    </style>
</head>
<body>

    <div id="alert-overlay"></div>

    <div id="top-left-controls">
        <button onclick="enableAudio()" id="btn-audio" class="btn-control">
            ğŸ”‡ é–‹å•ŸèªéŸ³
        </button>
    </div>

    <div id="right-controls">
        <button onclick="startGPS()" class="btn-control bg-green-600 text-white! hover:bg-green-700 shadow-lg">
            ğŸ›°ï¸ é‡å•Ÿ GPS
        </button>
        <button onclick="toggleSimulation()" class="btn-control bg-blue-600 text-white! hover:bg-blue-700 shadow-lg">
            ğŸš— æ¨¡æ“¬è¡Œé§›
        </button>
    </div>

    <div id="map"></div>

    <div id="dashboard">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <span id="gps-indicator" class="w-2 h-2 rounded-full bg-gray-500"></span>
                <span id="gps-text" class="text-xs text-gray-400">GPS æœªå•Ÿå‹•</span>
            </div>
            <div id="db-status" class="text-[10px] bg-yellow-700 px-2 py-1 rounded text-gray-200">
                è¼‰å…¥è³‡æ–™ä¸­...
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šç›®å‰è·¯åé¡¯ç¤º -->
        <div class="mb-2 pb-2 border-b border-gray-700">
            <div class="text-gray-400 text-xs font-bold tracking-wider">ç›®å‰ä½ç½® (OSM)</div>
            <div class="text-sm font-bold text-blue-300 truncate" id="current-road-display">
                åµæ¸¬ä¸­...
            </div>
        </div>

        <div class="flex justify-between items-end">
            <div>
                <div class="text-gray-400 text-xs font-bold tracking-wider">ç›®å‰æ™‚é€Ÿ</div>
                <div class="flex items-baseline gap-1">
                    <span class="text-5xl font-black font-mono tracking-tighter" id="speed-display">0</span>
                    <span class="text-sm text-gray-500 font-bold">km/h</span>
                </div>
            </div>
            <div class="text-right flex flex-col items-end">
                <div class="text-gray-400 text-xs font-bold tracking-wider mb-1">è·é›¢æ¸¬é€Ÿé»</div>
                <div class="text-3xl font-bold text-gray-500 font-mono" id="distance-display">-- <span class="text-sm">m</span></div>
                <div id="limit-box" class="mt-2 flex items-center gap-2 opacity-30 transition-opacity duration-300">
                    <span class="text-xs text-gray-400">é€Ÿé™</span>
                    <div class="w-8 h-8 rounded-full border-2 border-red-500 flex items-center justify-center bg-white text-black font-bold text-sm" id="limit-val">--</div>
                </div>
            </div>
        </div>

        <div id="alert-message-box" class="mt-3 py-2 px-3 bg-gray-800 rounded-lg text-center hidden transition-all duration-300">
            <span id="alert-text" class="text-lg font-bold"></span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const DATA_URL = './cameras.json'; 

        const MOCK_DATA = [
            { id: "mock1", address: "è‡ºåŒ—å¸‚ä¿¡ç¾©å€ä¿¡ç¾©è·¯äº”æ®µ (æ¨¡æ“¬é»)", limit: 50, lat: 25.032969, lng: 121.560000 },
            { id: "mock2", address: "è‡ºåŒ—å¸‚ä¿¡ç¾©å€æ¾é«˜è·¯ (æ¨¡æ“¬é»)", limit: 60, lat: 25.035000, lng: 121.568000 },
            { id: "mock3", address: "è‡ºåŒ—å¸‚å¤§å®‰å€å…‰å¾©å—è·¯ (æ¨¡æ“¬é»)", limit: 40, lat: 25.040000, lng: 121.558000 },
            { id: "mock4", address: "è‡ºåŒ—å¸‚ä¿¡ç¾©å€èŠæ•¬è·¯ (æ¨¡æ“¬é»)", limit: 50, lat: 25.028000, lng: 121.565000 },
            { id: "mock5", address: "è‡ºåŒ—å¸‚ä¿¡ç¾©å€åŸºéš†è·¯ä¸€æ®µ (æ¨¡æ“¬é»)", limit: 50, lat: 25.041000, lng: 121.565000 }
        ];

        const CONFIG = { 
            WARN_DIST: 600, 
            ALERT_DIST: 300, 
            RESET_DIST: 800,
            VIEW_ANGLE: 40 
        };
        
        let map, userMarker;
        let cameras = [];
        let currentPos = { lat: 25.033964, lng: 121.564468 }; 
        let watchId = null;
        let audioEnabled = false;
        let speechState = { hasWarned600: false, hasWarned300: false, currentCameraId: null };
        let isSimulating = false;
        let simInterval;
        
        // è·¯ååµæ¸¬ç›¸é—œè®Šæ•¸
        let currentRoadName = null;
        let lastRoadFetchTime = 0;
        let lastRoadFetchPos = null;

        function init() {
            initMap();
            loadCameras();
            startGPS();
        }

        function initMap() {
            const darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap, Â© CartoDB', maxZoom: 19 });
            const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap, Â© CartoDB', maxZoom: 19 });
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap', maxZoom: 19 });

            // é è¨­ä½¿ç”¨è¡—é“æ¨¡å¼
            document.getElementById('map').classList.add('mode-street');
            map = L.map('map', { zoomControl: false, layers: [osmLayer] }).setView([currentPos.lat, currentPos.lng], 15);
            L.control.layers({ "æ·±è‰² (Dark)": darkLayer, "æ·ºè‰² (Light)": lightLayer, "è¡—é“ (Street)": osmLayer }, null, {position: 'topright'}).addTo(map);

            map.on('baselayerchange', function(e) {
                const mapDiv = document.getElementById('map');
                mapDiv.classList.remove('mode-dark', 'mode-light', 'mode-street');
                if (e.name.includes("æ·±è‰²")) mapDiv.classList.add('mode-dark');
                else if (e.name.includes("æ·ºè‰²")) mapDiv.classList.add('mode-light');
                else mapDiv.classList.add('mode-street');
            });

            const carIcon = L.divIcon({
                className: 'custom-car',
                html: `<div style="background:#3B82F6; width:24px; height:24px; border-radius:50%; border:3px solid white; box-shadow:0 0 15px #3B82F6;"></div>`,
                iconSize: [24, 24], iconAnchor: [12, 12]
            });
            userMarker = L.marker([currentPos.lat, currentPos.lng], {icon: carIcon, zIndexOffset: 1000}).addTo(map);

            map.on('click', (e) => {
                if(!watchId) startSimulation(e.latlng);
            });
        }

        async function loadCameras() {
            const statusTag = document.getElementById('db-status');
            try {
                const response = await fetch(DATA_URL);
                if (!response.ok) throw new Error("JSON not found or fetch failed");
                cameras = await response.json();
                statusTag.innerText = `âœ… å·²è¼‰å…¥: ${cameras.length} ç­†è³‡æ–™ (Static)`;
                statusTag.classList.replace('bg-yellow-700', 'bg-green-700');
            } catch (e) {
                console.warn("Fetch failed, using mock data. Reason:", e);
                cameras = MOCK_DATA;
                statusTag.innerText = "âš ï¸ é è¦½æ¨¡å¼: ä½¿ç”¨æ¨¡æ“¬è³‡æ–™ (JSON æœªè¼‰å…¥)";
                statusTag.classList.replace('bg-yellow-700', 'bg-blue-600');
            }
            renderCameras();
        }

        function renderCameras() {
             const icon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/3256/3256054.png',
                iconSize: [28, 28], iconAnchor: [14, 14], popupAnchor: [0, -10],
                className: 'camera-icon-img'
            });
            cameras.forEach(cam => {
                L.marker([cam.lat, cam.lng], {icon: icon})
                    .bindPopup(`<div class="text-black font-bold">${cam.address}<br>é™é€Ÿ: ${cam.limit}</div>`)
                    .addTo(map);
            });
        }

        // --- è·¯åæŸ¥è©¢åŠŸèƒ½ (ä½¿ç”¨ OSM Nominatim API) ---
        async function fetchRoadName(lat, lng) {
            const now = Date.now();
            // ç¯€æµé–¥ï¼šæ¯ 10 ç§’æˆ–ç§»å‹• > 50m æ‰æŸ¥è©¢ä¸€æ¬¡ï¼Œé¿å… API å°é–
            if (now - lastRoadFetchTime < 10000 && lastRoadFetchPos && getDistance(lat, lng, lastRoadFetchPos.lat, lastRoadFetchPos.lng) < 50) {
                return;
            }

            lastRoadFetchTime = now;
            lastRoadFetchPos = { lat, lng };

            try {
                // ä½¿ç”¨ OpenStreetMap å…è²» API æŸ¥è©¢åœ°å€
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=zh-TW`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.address) {
                    // å„ªå…ˆå–å¾—é“è·¯åç¨±
                    const road = data.address.road || data.address.pedestrian || data.address.street || "æœªçŸ¥é“è·¯";
                    currentRoadName = road;
                    
                    // æ›´æ–° UI
                    const roadDisplay = document.getElementById('current-road-display');
                    roadDisplay.innerText = road;
                    roadDisplay.classList.remove('text-gray-500');
                    roadDisplay.classList.add('text-blue-300');
                }
            } catch (e) {
                console.warn("è·¯åæŸ¥è©¢å¤±æ•—:", e);
                // å¤±æ•—æ™‚ä¸æ¸…é™¤èˆŠè·¯åï¼Œé¿å…é–ƒçˆ
            }
        }

        function checkProximity(lat, lng, speed = 0, heading = null) {
            // æ¯æ¬¡ä½ç½®æ›´æ–°å˜—è©¦æŸ¥è©¢è·¯å
            fetchRoadName(lat, lng);

            if (cameras.length === 0) return;
            
            let minDist = Infinity;
            let nearestCam = null;

            for (let cam of cameras) {
                const d = getDistance(lat, lng, cam.lat, cam.lng);
                
                // 1. è·é›¢éæ¿¾
                if (d > CONFIG.WARN_DIST) continue;

                // 2. æ–¹å‘éæ¿¾ (Vector Logic - ç¬¬ä¸€é“é˜²ç·š)
                if (speed > 5 && heading !== null && heading !== undefined) {
                    const bearingToCam = getBearing(lat, lng, cam.lat, cam.lng);
                    let angleDiff = Math.abs(heading - bearingToCam);
                    if (angleDiff > 180) angleDiff = 360 - angleDiff;
                    
                    // å¤¾è§’å¤§æ–¼ 40 åº¦å‰‡å¿½ç•¥
                    if (angleDiff > CONFIG.VIEW_ANGLE) continue; 
                }

                // 3. è·¯åæ¯”å° (Road Name Match - ç¬¬äºŒé“é˜²ç·š)
                // åªæœ‰ç•¶æˆ‘å€‘æˆåŠŸæŠ“åˆ°è·¯åï¼Œä¸”ç›¸æ©Ÿåœ°å€ä¹Ÿæœ‰æ•ˆæ™‚æ‰é€²è¡Œæ¯”å°
                if (currentRoadName && currentRoadName !== "æœªçŸ¥é“è·¯" && cam.address) {
                    // ç°¡å–®å­—ä¸²æ¯”å°ï¼šå¦‚æœç›¸æ©Ÿåœ°å€ ä¸åŒ…å« ç›®å‰è·¯å
                    // ä¾‹å¦‚ï¼šç›®å‰åœ¨ã€Œä»æ„›è·¯ã€ï¼Œç›¸æ©Ÿåœ¨ã€Œä¿¡ç¾©è·¯ã€ï¼Œå‰‡å¿½ç•¥
                    // æ³¨æ„ï¼šéœ€è™•ç†ã€Œæ®µã€å­—ï¼Œä¾‹å¦‚ "ä¿¡ç¾©è·¯" æ‡‰åŒ¹é… "ä¿¡ç¾©è·¯äº”æ®µ"
                    // ç­–ç•¥ï¼šå¦‚æœç›®å‰è·¯åæ˜¯ "ä¿¡ç¾©è·¯äº”æ®µ"ï¼Œè€Œç›¸æ©Ÿæ˜¯ "ä¿¡ç¾©è·¯"ï¼Œé€™ç®—ä¸ç¬¦åˆï¼Ÿ
                    // å¯¬é¬†ç­–ç•¥ï¼šå¦‚æœç›¸æ©Ÿåœ°å€å®Œå…¨ä¸åŒ…å«ç›®å‰è·¯åçš„å‰2å€‹å­—(å‡è¨­è·¯åå¤§æ–¼2å­—)ï¼Œå‰‡æ‡·ç–‘æ˜¯å¹³è¡Œé“è·¯
                    
                    // å¯¦ä½œï¼šç›´æ¥æª¢æŸ¥åŒ…å«é—œä¿‚
                    // åªæœ‰ç•¶ currentRoadName æ˜ç¢ºä¸”é•·åº¦è¶³å¤ æ™‚æ‰å•Ÿç”¨éæ¿¾
                    if (currentRoadName.length >= 2) {
                        // å¦‚æœç›¸æ©Ÿåœ°å€è£¡é¢ æ‰¾ä¸åˆ° ç›®å‰çš„è·¯åï¼Œå°±è¦–ç‚ºä¸åŒè·¯
                        if (!cam.address.includes(currentRoadName)) {
                            // ç‰¹æ®Šè™•ç†ï¼šæœ‰æ™‚å€™ OSM å›å‚³ "ä¿¡ç¾©è·¯"ï¼Œç›¸æ©Ÿæ˜¯ "ä¿¡ç¾©è·¯äº”æ®µ"ï¼Œé€™æ˜¯ Match çš„
                            // åä¹‹ OSM å›å‚³ "ä¿¡ç¾©è·¯äº”æ®µ"ï¼Œç›¸æ©Ÿæ˜¯ "ä¿¡ç¾©è·¯"ï¼Œé€™ä¹Ÿæ˜¯ Match çš„
                            // é€™è£¡åšä¸€å€‹ç°¡å–®çš„é›™å‘æª¢æŸ¥ï¼Œå¦‚æœå…©é‚Šéƒ½å®Œå…¨æ²’äº¤é›†ï¼Œæ‰éæ¿¾
                            
                            // æå–è·¯åæ ¸å¿ƒ (å»é™¤ æ®µ/å··/å¼„) - ç°¡æ˜“ç‰ˆ
                            const coreRoadName = currentRoadName.replace(/æ®µ.*/, '').replace(/\d+è™Ÿ.*/, '');
                            if (!cam.address.includes(coreRoadName)) {
                                // çœŸçš„ä¸åŒ…å«ï¼Œè·³éæ­¤ç›¸æ©Ÿ (è¦–ç‚ºå¹³è¡Œé“è·¯)
                                console.log(`éæ¿¾å¹³è¡Œé“è·¯: ç›®å‰åœ¨ ${currentRoadName}, ç›¸æ©Ÿåœ¨ ${cam.address}`);
                                continue;
                            }
                        }
                    }
                }

                if (d < minDist) {
                    minDist = d;
                    nearestCam = cam;
                }
            }
            
            updateUI(minDist, nearestCam, speed);
            handleVoiceAlert(minDist, nearestCam);
        }

        function startGPS() {
            if (isSimulating) { clearInterval(simInterval); isSimulating = false; }

            const indicator = document.getElementById('gps-indicator');
            const text = document.getElementById('gps-text');

            indicator.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
            text.innerText = "GPS å®šä½ä¸­...";

            if (!navigator.geolocation) {
                text.innerText = "ä¸æ”¯æ´ GPS";
                indicator.className = "w-2 h-2 rounded-full bg-red-500";
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                (pos) => {
                    const { latitude, longitude, speed, heading } = pos.coords;
                    currentPos = { lat: latitude, lng: longitude };
                    
                    userMarker.setLatLng([latitude, longitude]);
                    map.setView([latitude, longitude], 17); 
                    
                    const kmh = speed ? Math.round(speed * 3.6) : 0;
                    checkProximity(latitude, longitude, kmh, heading);

                    indicator.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                    text.innerText = "GPS é€£ç·šä¸­";
                },
                (err) => {
                    indicator.className = "w-2 h-2 rounded-full bg-red-500";
                    let errorMsg = "GPS å®šä½å¤±æ•—";
                    if (err.message && err.message.includes("permissions policy")) {
                        errorMsg = "é è¦½ä¸æ”¯æ´ GPS (è«‹æŒ‰æ¨¡æ“¬)";
                        console.warn("ã€ç’°å¢ƒé™åˆ¶ã€‘é è¦½æ¨¡å¼ä¸æ”¯æ´ GPSï¼Œè«‹ä½¿ç”¨å³å´ã€Œæ¨¡æ“¬è¡Œé§›ã€åŠŸèƒ½ï¼Œæˆ–å°‡ç¨‹å¼ç¢¼ä¸‹è¼‰è‡³æœ¬åœ°æ¸¬è©¦ã€‚");
                    } else {
                        console.error("GPS Error Details:", { code: err.code, message: err.message });
                        switch(err.code) {
                            case 1: errorMsg = "GPS æ¬Šé™è¢«æ‹’çµ•"; break;
                            case 2: errorMsg = "è¨Šè™Ÿå¾®å¼±æˆ–ç„¡ç¡¬é«”"; break;
                            case 3: errorMsg = "GPS å®šä½é€¾æ™‚"; break;
                        }
                    }
                    text.innerText = errorMsg;
                }, 
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function startSimulation(targetLatLng) {
            isSimulating = true;
            const start = currentPos;
            const steps = 200;
            let step = 0;
            let mockSpeed = Math.floor(Math.random() * 40) + 40; 
            
            const simHeading = getBearing(start.lat, start.lng, targetLatLng.lat, targetLatLng.lng);

            simInterval = setInterval(() => {
                step++;
                const progress = step / steps;
                const lat = start.lat + (targetLatLng.lat - start.lat) * progress;
                const lng = start.lng + (targetLatLng.lng - start.lng) * progress;
                currentPos = { lat, lng };
                userMarker.setLatLng([lat, lng]);
                map.panTo([lat, lng]);
                
                checkProximity(lat, lng, mockSpeed, simHeading);
                
                if (step >= steps) { clearInterval(simInterval); isSimulating = false; updateUI(Infinity, null, 0); }
            }, 20);
        }

        function toggleSimulation() { alert("é»æ“Šåœ°åœ–æ¨¡æ“¬è¡Œé§›"); }
        
        function getBearing(lat1, lng1, lat2, lng2) {
            const dLon = toRad(lng2 - lng1);
            const y = Math.sin(dLon) * Math.cos(toRad(lat2));
            const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                      Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
            let brng = toDeg(Math.atan2(y, x));
            return (brng + 360) % 360;
        }

        function toRad(deg) { return deg * Math.PI / 180; }
        function toDeg(rad) { return rad * 180 / Math.PI; }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180, Ï†2 = lat2 * Math.PI/180;
            const a = Math.sin((lat2-lat1)*Math.PI/360)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin((lon2-lon1)*Math.PI/360)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateUI(dist, cam, speed) {
            document.getElementById('speed-display').innerText = speed;
            const elDist = document.getElementById('distance-display');
            const elMsgBox = document.getElementById('alert-message-box');
            if (dist > 2000 || !cam) {
                elDist.innerText = "--"; document.getElementById('alert-overlay').style.display = 'none'; elMsgBox.classList.add('hidden'); return;
            }
            elDist.innerText = Math.round(dist);
            document.getElementById('limit-val').innerText = cam.limit;
            if (dist <= CONFIG.ALERT_DIST) {
                document.getElementById('alert-overlay').style.display = 'block';
                elMsgBox.classList.remove('hidden');
                elMsgBox.innerHTML = `<span class="text-xl font-bold text-red-400">âš ï¸ é™é€Ÿ ${cam.limit}</span>`;
            } else if (dist <= CONFIG.WARN_DIST) {
                document.getElementById('alert-overlay').style.display = 'none';
                elMsgBox.classList.remove('hidden');
                elMsgBox.innerHTML = `<span class="text-lg font-bold text-yellow-300">ğŸ”” å‰æ–¹æ¸¬é€Ÿ</span>`;
            } else {
                document.getElementById('alert-overlay').style.display = 'none'; elMsgBox.classList.add('hidden');
            }
        }
        function handleVoiceAlert(dist, cam) {
            if (!audioEnabled || !cam) return;
            if (speechState.currentCameraId !== cam.id || dist > CONFIG.RESET_DIST) speechState = { hasWarned600: false, hasWarned300: false, currentCameraId: cam.id };
            if (dist <= CONFIG.WARN_DIST && dist > CONFIG.ALERT_DIST && !speechState.hasWarned600) { speak(`å‰æ–¹æ¸¬é€Ÿï¼Œé™é€Ÿ${cam.limit}`); speechState.hasWarned600 = true; }
            if (dist <= CONFIG.ALERT_DIST && !speechState.hasWarned300) { speak(`æ³¨æ„ï¼Œé™é€Ÿ${cam.limit}`); speechState.hasWarned300 = true; }
        }
        function speak(text) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'zh-TW'; u.rate = 1.2; window.speechSynthesis.speak(u); }
        function enableAudio() { audioEnabled = true; document.getElementById('btn-audio').innerText = "ğŸ”Š èªéŸ³é–‹å•Ÿ"; speak("èªéŸ³å•Ÿå‹•"); }
        
        init();
    </script>
</body>
</html>