name: Weekly Camera Update

# 設定觸發條件
on:
  schedule:
    # 台灣時間每週一早上 08:00
    # GitHub 使用 UTC 時間，台灣是 UTC+8
    # 所以 UTC 00:00 = 台灣 08:00
    - cron: '0 0 * * 1'
  
  # 允許手動點擊按鈕觸發 (方便測試)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
    # 1. 下載您的程式碼
    - name: Checkout repository
      uses: actions/checkout@v4

    # 2. 設定 Node.js 環境
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 3. 安裝套件 (依照 package.json)
    - name: Install dependencies
      run: npm install

    # 4. 執行更新腳本 (這裡沒有金鑰，但新的腳本會自動切換成 JSON 模式)
    - name: Run update script
      run: node backend-scripts/update_data.js

    # 5. 檢查是否有變更並上傳
    - name: Commit and push if changed
      run: |
        git config --global user.name 'GitHub Action Bot'
        git config --global user.email 'action@github.com'
        git add cameras.json
        # 如果沒有變更 (diff-index --quiet 回傳 0)，就不執行 commit，避免報錯
        git diff-index --quiet HEAD || git commit -m "Auto-update: cameras.json (Weekly)"
        git push